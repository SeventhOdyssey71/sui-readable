<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sui Transaction Explainer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Funnel+Display:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #f4f4f4;
        --panel: #fff;
        --muted: #6a6a6a;
        --border: #e1e1e1;
        --text: #0b0b0b;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Google Sans", "Funnel Display", -apple-system,
          BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      main {
        max-width: 760px;
        margin: 0 auto;
        padding: 48px 20px 72px;
        display: flex;
        flex-direction: column;
        gap: 28px;
      }
      h1 {
        font-family: "Funnel Display", "Google Sans", sans-serif;
        font-size: clamp(2.2rem, 5vw, 3.1rem);
        font-weight: 500;
        letter-spacing: -0.02em;
        margin: 8px 0;
      }
      p {
        color: var(--muted);
        line-height: 1.6;
        margin: 0;
      }
      .eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.32em;
        font-size: 12px;
      }
      .card {
        background: var(--panel);
        border-radius: 26px;
        border: 1px solid var(--border);
        padding: 28px;
        box-shadow: 0 20px 45px rgba(0, 0, 0, 0.05);
      }
      label {
        display: block;
        margin-bottom: 10px;
        font-weight: 500;
      }
      input {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px;
        font-size: 1rem;
        background: #f7f7f7;
      }
      input:focus {
        outline: none;
        background: #fff;
        border-color: #0b0b0b;
      }
      button {
        width: 100%;
        border: none;
        border-radius: 16px;
        background: #0b0b0b;
        color: #fff;
        padding: 16px;
        font-size: 0.95rem;
        letter-spacing: 0.08em;
        font-weight: 600;
        text-transform: uppercase;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.35;
        cursor: not-allowed;
      }
      .examples {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 18px;
        font-size: 0.9rem;
      }
      .examples a {
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 6px 14px;
        text-decoration: none;
        color: var(--text);
      }
      .examples a:hover {
        background: #0b0b0b;
        color: #fff;
      }
      .hidden {
        display: none;
      }
      .summary {
        background: #f7f7f7;
        border-radius: 18px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
      }
      .meta div {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 12px 16px;
        font-size: 0.95rem;
      }
      .section-title {
        margin: 24px 0 12px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 6px;
      }
      .item {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 14px;
        margin-bottom: 10px;
        background: #fafafa;
        line-height: 1.5;
      }
      .object-details {
        font-size: 0.8rem;
        color: var(--muted);
        margin-top: 6px;
        font-family: "Google Sans", "SF Mono", "Roboto Mono", monospace;
      }
      .balance-row {
        display: flex;
        justify-content: space-between;
        gap: 12px;
      }
    </style>
  </head>
  <body>
    <main>
      <section style="text-align: center">
        <p class="eyebrow">Sui Readable</p>
        <h1>Transaction clarity without the noise</h1>
        <p>
          Paste a digest and review a precise explanation in a monochrome,
          Apple-style canvas.
        </p>
      </section>

      <section class="card">
        <label for="digest">Transaction Digest</label>
        <input
          id="digest"
          type="text"
          placeholder="2vN4jBW8R4k6K3v9xsNZ8L4k2j3B5h6N..."
        />
        <button id="explainBtn" onclick="explainTransaction()">
          Explain Transaction
        </button>
        <div class="examples">
          <span>Need an example?</span>
          <a href="#" onclick="return loadExample('2vN4jBW8R4k6K3v9xsNZ8L4k2j3B5h6N7m8K9L0P1Q2R3S4T5U6V7W8X9Y0Z1A2')"
            >Example 1</a
          >
          <a href="#" onclick="return loadExample('3wO5kCX9S5l7L4w0ytOA9M5l3k4C6i7O8n9L0M1P2Q3R4S5T6U7V8W9X0Y1Z2B3')"
            >Example 2</a
          >
        </div>
      </section>

      <section id="loading" class="card hidden" aria-live="polite">
        <p class="eyebrow">Fetching & decoding</p>
      </section>

      <section id="result" class="card hidden"></section>
    </main>

    <script>
      const digestEl = document.getElementById("digest");
      const resultEl = document.getElementById("result");
      const loadingEl = document.getElementById("loading");
      const btn = document.getElementById("explainBtn");

      function loadExample(digest) {
        digestEl.value = digest;
        explainTransaction();
        return false;
      }

      async function explainTransaction() {
        const digest = digestEl.value.trim();
        if (!digest) return alert("Please enter a transaction digest");

        resultEl.classList.add("hidden");
        loadingEl.classList.remove("hidden");
        btn.disabled = true;

        try {
          const res = await fetch("/api/explain", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ digest }),
          });
          const data = await res.json();
          data.success ? displayExplanation(data.explanation) : displayError(data.error);
        } catch (err) {
          displayError("Failed to connect: " + err.message);
        } finally {
          loadingEl.classList.add("hidden");
          btn.disabled = false;
        }
      }

      function displayExplanation(exp = {}) {
        let html = `
          <div class="summary">${exp.summary || "No summary available."}</div>
          <div class="meta">
            <div><strong>Status</strong><br />${exp.status || "-"}</div>
            <div><strong>Gas Used</strong><br />${exp.gas_used_sui || "-"}</div>
            <div><strong>Sender</strong><br />${shorten(exp.sender)}</div>
            <div><strong>Digest</strong><br />${shorten(exp.digest)}</div>
          </div>
        `;

        html += buildSection("Actions", exp.actions);
        html += buildSection(
          "Balance Changes",
          exp.balance_changes,
          (balance) => `
            <div class="item balance-row">
              <div>
                <strong>${shorten(balance.owner)}</strong>
                <div class="object-details">${balance.coin_type}</div>
              </div>
              <div>${balance.amount_readable}</div>
            </div>
          `,
        );
        html += buildSection(
          "Object Changes",
          exp.object_changes,
          (obj) => `
            <div class="item">
              <div>${obj.details}</div>
              <div class="object-details">
                ${obj.change_type} • ${obj.object_type} • ${shorten(obj.object_id)}
              </div>
            </div>
          `,
        );
        html += buildSection("Events", exp.events);

        html += `
          <button onclick="resetForm()" style="margin-top: 10px">
            Explain Another Transaction
          </button>
        `;

        resultEl.innerHTML = html;
        resultEl.classList.remove("hidden");
      }

      function buildSection(title, list, template = (item) => `<div class="item">${item}</div>`) {
        if (!Array.isArray(list) || !list.length) return "";
        return `
          <h3 class="section-title">${title}</h3>
          ${list.map(template).join("")}
        `;
      }

      function displayError(message = "Unknown error") {
        resultEl.innerHTML = `
          <div class="item" style="border-radius: 20px">
            <strong>Something went wrong</strong>
            <p>${message}</p>
          </div>
          <button onclick="resetForm()" style="margin-top: 10px">Try Again</button>
        `;
        resultEl.classList.remove("hidden");
      }

      function resetForm() {
        digestEl.value = "";
        resultEl.classList.add("hidden");
        digestEl.focus();
      }

      function shorten(value) {
        if (!value || value.length <= 12) return value || "-";
        return `${value.slice(0, 8)}...${value.slice(-6)}`;
      }

      digestEl.addEventListener("keypress", (e) => {
        if (e.key === "Enter") explainTransaction();
      });
    </script>
  </body>
</html>
